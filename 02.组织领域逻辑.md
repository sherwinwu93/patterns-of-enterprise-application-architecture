### 第2章 组织领域逻辑
领域逻辑的组织可以分为三种主要的模式: 事务脚本、领域模型以及表模块.

保存领域逻辑最简单的办法是使用事务脚本.事务脚本是这样一个过程: 从表示层获得输入、进行校验和计算处理、将数据存储到数据库中以及调
用其他系统的操作等.然后该过程将更多的数据返回给表示层,中间可能哟啊进行大量的计算来组织和整理返回值.基本的组织方式是让每个过程对
应用户可能做的一个动作.所以,我们可以将这一模式想象成一个动作或业务事务的脚本.该脚本不必一定是单个的内嵌过程,还可以分离成不同的子
例程,这些子例程可以在不同的事务脚本之间共享.但是,每一个动作还是由一个过程来驱动.例如,一个零售系统可能会有结账、将商品放入购物车
、显示交货状态以及其他一些事务脚本.

事务脚本有以下几个优点:
1. 它是一个大多数开发者都能理解的简单过程模型.
2. 它能够与一个使用行数据入口或表数据入口的简单数据源层很好地协作.
3. 设定事务边界的方法显而易见: 一个事务始于其脚本的打开,终于其脚本的关闭.很容易用工具在幕后设定事务边界.

用领域模型而不是事务脚本正是面向对象鼓吹的"理论体系转换"的精髓.在领域模型中,不再由一个过程来控制用户某一动作的逻辑,而是由每一个
对象都承担一部分相关逻辑.如果不习惯领域模型,开始学习使用它时会充满挫折感,为了找到行为在那里,你会从一个对象冲到另一个对象.

图2-1 图2-2

在图2-1中,事务脚本中的calculateRecognitions方法完成所有的工作.底层对象只有一些表数据入口,它们仅仅完成将数据传送给事务脚本的任
务.

反之在图2-2中有多个对象,它们每个都向前传递一部分行为给另一个对象,直至策略对象创建了结果.

领域模型的价值在于一旦掌握了它,就可运用许多现成的技术来较好的组织日趋复杂的领域逻辑.例如,当增加新的收入确认算法时,只需增加相应
的新策略对象即可.而使用事务脚本则需要在脚本的判断逻辑中增加许多新的条件.

领域模型的开销来自使用上的复杂性和数据源层的复杂性.刚接触复杂对象模型的人需要实践来适应复杂的领域模型.但是,一旦习惯了领域模型,
一般就可以在将来很好地运用它,从而受益终生.

即使成功地完成这一转变,还需要面对将领域模型映射到数据库的问题.运用领域模型越充分,当你将它映射到关系数据库时就越复杂.

第三种组织领域逻辑的模块是表模块.这一模式咋看起来与领域模型很相似,它们都有合同、产品和收入确认类.关键的区别在于领域模型对数据库
中每一个合同都有一个相应合同类的实例,而表模块只有一个公共的合同类是咧.表模块设计成与记录集一起工作.

在许多方面,表模块式事务脚本和领域模型的一个中间地带.它围绕表而非直接围绕过程来组织领域逻辑,提供了更多的结构,而且更容易发现和移
除冗余代码.但是,你无法应用许多在领域模型中可以使用的组织细粒度结构的技术,例如集成、策略和其他面向对象的设计模式.

#### 2.1 抉择
选择很大程度上取决于逻辑领域的复杂度.

只要领域逻辑复杂度大于7.42,就应当使用领域模型.但是,没有人知道如何测定领域逻辑的复杂度.因此,能做的只有向有经验的开发者请教.

事先花费一些时间来进行思考和选择是值得的,如果在开发过程中才发现你的选择是错误的,且原来的选择是事务脚本,那么不要犹豫,应立即改用
领域模型.如果原来的模式是领域模型,中途转而采用事务脚本,这通常不太值得,除非能简化你的数据源层.

这三种模式并不互相排斥.实际上,使用事务脚本来处理一部分领域逻辑,同时使用表模块或领域模型来处理剩下的部分,这是很常见的.

#### 2.2 服务层
处理领域逻辑的常用方法是将领域层再细分成两层.服务层独立出来,置于底层的领域模型或表模块之上.通常只有使用领域模型或表模块时才会这
样细分,因为仅使用事务脚本的领域层并不复杂.

在提供一个清晰的API的同时,服务层也是放置事务控制和安全等功能的好场所.

如果设立了服务层,服务层只是一个外观,所有实际的行为都在下层的对象中,服务层所作的只是将上层调用传递到更低层.在这种情况下,服务层提
供一个更易于使用的API,服务层要做的只是将上层调用传递到更低层.在这种情况下,服务层提供一个更易于使用的API,因为它的方法通常根据用
例来组织.此时,它提供一个很方便的切入点,用来增加事务封装和安全检查等功能.

另一个极端则是将大多数业务逻辑都以事务脚本的形式置于服务层中,下层的领域对象变得极为简单.如果下层是领域模型,则其中的对象与数据库
一一对应,因而你就可以使用诸如活动记录等较简单的数据源层.

以上两者的折中是一个行为的混合体: 控制器-实体风格.此处要点在于:将单个事务或用例所特有的逻辑置于事务脚本之上,它们通常被称为控制器
或服务.有许多不同的控制器,如模型-视图-控制器中的输入控制器和我们稍后会接触到的应用控制器.所以在此处我使用术语"用例控制器".

如果确实决定完全选用领域模型,就应当彻底贯彻这一模式,使它在应用程序中占主导地位.一个例外是已经从采用了行数据入口的事务脚本开始了,
那么可以将冗余行为移到行数据入口中,这样就将它转变成一个使用活动记录的简单领域模型.

因此,我的建议是:如果你确实需要,尽可能使用最小化的服务层.我通常假定并不需要这么一层,然后当发现应用确实需要时才增加.但是,我也知道
许多优秀的软件设计者总是使用一个包含了合理数量逻辑的服务层.

